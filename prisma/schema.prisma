generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   BigInt               @id @default(autoincrement())
  name                 String
  email                String               @unique
  phone                String?
  passwordHash         String               @map("password_hash")
  profilePictureUrl    String?              @map("profile_picture_url")
  role                 UserRole             @default(CUSTOMER)
  isActive             Boolean              @default(true) @map("is_active")
  mustChangePassword   Boolean              @default(false) @map("must_change_password")
  resetToken           String?              @map("reset_token")
  resetTokenExpiresAt  DateTime?            @map("reset_token_expires_at") @db.Timestamptz(6)
  lastLoginAt          DateTime?            @map("last_login_at") @db.Timestamptz(6)
  createdAt            DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchantUsers        MerchantUser[]
  statusChanges        OrderStatusHistory[]
  ordersAsCustomer     Order[]              @relation("CustomerOrders")
  sessions             UserSession[]
  preferences          UserPreference?
  menusCreated         Menu[]               @relation("MenuCreatedBy")
  menusUpdated         Menu[]               @relation("MenuUpdatedBy")
  menusDeleted         Menu[]               @relation("MenuDeletedBy")
  categoriesCreated    MenuCategory[]       @relation("CategoryCreatedBy")
  categoriesUpdated    MenuCategory[]       @relation("CategoryUpdatedBy")
  categoriesDeleted    MenuCategory[]       @relation("CategoryDeletedBy")
  addonCatsCreated     AddonCategory[]      @relation("AddonCatCreatedBy")
  addonCatsUpdated     AddonCategory[]      @relation("AddonCatUpdatedBy")
  addonCatsDeleted     AddonCategory[]      @relation("AddonCatDeletedBy")
  addonItemsCreated    AddonItem[]          @relation("AddonItemCreatedBy")
  addonItemsUpdated    AddonItem[]          @relation("AddonItemUpdatedBy")
  addonItemsDeleted    AddonItem[]          @relation("AddonItemDeletedBy")

  @@index([email])
  @@index([role])
  @@map("users")
}

model UserSession {
  id               BigInt        @id @default(autoincrement())
  userId           BigInt        @map("user_id")
  token            String        @unique
  deviceInfo       String?       @map("device_info")
  ipAddress        String?       @map("ip_address")
  status           SessionStatus @default(ACTIVE)
  expiresAt        DateTime      @map("expires_at") @db.Timestamptz(6)
  refreshExpiresAt DateTime?     @map("refresh_expires_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([status])
  @@map("user_sessions")
}

model UserPreference {
  id                  BigInt   @id @default(autoincrement())
  userId              BigInt   @unique @map("user_id")
  theme               String   @default("light")
  language            String   @default("en")
  timezone            String   @default("Asia/Jakarta")
  dateFormat          String   @default("DD/MM/YYYY") @map("date_format")
  timeFormat          String   @default("24h") @map("time_format")
  currency            String   @default("IDR")
  emailNotifications  Boolean  @default(true) @map("email_notifications")
  orderNotifications  Boolean  @default(true) @map("order_notifications")
  marketingEmails     Boolean  @default(false) @map("marketing_emails")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_preferences")
}

model MerchantUser {
  id         BigInt       @id @default(autoincrement())
  merchantId BigInt       @map("merchant_id")
  userId     BigInt       @map("user_id")
  role       MerchantRole @default(STAFF)
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([merchantId, userId])
  @@index([merchantId])
  @@index([userId])
  @@map("merchant_users")
}

model Merchant {
  id              BigInt                @id @default(autoincrement())
  code            String                @unique
  name            String
  email           String
  phone           String?
  address         String?
  city            String?
  state           String?
  postalCode      String?               @map("postal_code")
  country         String                @default("Australia")
  logoUrl         String?               @map("logo_url")
  mapUrl          String?               @map("map_url")
  description     String?
  isActive        Boolean               @default(true) @map("is_active")
  isOpen          Boolean               @default(true) @map("is_open")
  enableTax       Boolean               @default(false) @map("enable_tax")
  taxPercentage   Decimal?              @map("tax_percentage") @db.Decimal(5, 2)
  currency        String                @default("AUD")
  timezone        String                @default("Australia/Sydney")
  latitude        Decimal?              @db.Decimal(10, 8)
  longitude       Decimal?              @db.Decimal(11, 8)
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCategories AddonCategory[]
  menuCategories  MenuCategory[]
  menus           Menu[]
  openingHours    MerchantOpeningHour[]
  merchantUsers   MerchantUser[]
  orders          Order[]

  @@index([code])
  @@index([isActive])
  @@map("merchants")
}

model MerchantOpeningHour {
  id         BigInt   @id @default(autoincrement())
  merchantId BigInt   @map("merchant_id")
  dayOfWeek  Int      @map("day_of_week")
  openTime   String?  @map("open_time")
  closeTime  String?  @map("close_time")
  isClosed   Boolean  @default(false) @map("is_closed")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, dayOfWeek])
  @@map("merchant_opening_hours")
}

model MenuCategory {
  id                BigInt             @id @default(autoincrement())
  merchantId        BigInt             @map("merchant_id")
  name              String
  description       String?
  sortOrder         Int                @default(0) @map("sort_order")
  isActive          Boolean            @default(true) @map("is_active")
  createdByUserId   BigInt?            @map("created_by_user_id")
  updatedByUserId   BigInt?            @map("updated_by_user_id")
  deletedAt         DateTime?          @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId   BigInt?            @map("deleted_by_user_id")
  createdAt         DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant          Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  menus             Menu[]             // Keep for backward compatibility
  menuItems         MenuCategoryItem[] // Many-to-many relation
  createdBy         User?              @relation("CategoryCreatedBy", fields: [createdByUserId], references: [id])
  updatedBy         User?              @relation("CategoryUpdatedBy", fields: [updatedByUserId], references: [id])
  deletedBy         User?              @relation("CategoryDeletedBy", fields: [deletedByUserId], references: [id])

  @@index([merchantId])
  @@index([sortOrder])
  @@index([deletedAt])
  @@map("menu_categories")
}

// Junction table for many-to-many Menu <-> Category
model MenuCategoryItem {
  id         BigInt       @id @default(autoincrement())
  menuId     BigInt       @map("menu_id")
  categoryId BigInt       @map("category_id")
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  menu       Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)
  category   MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([menuId, categoryId])
  @@index([menuId])
  @@index([categoryId])
  @@map("menu_category_items")
}

model Menu {
  id                  BigInt              @id @default(autoincrement())
  merchantId          BigInt              @map("merchant_id")
  categoryId          BigInt?             @map("category_id") // Keep for backward compatibility
  name                String
  description         String?
  price               Decimal             @db.Decimal(10, 2)
  imageUrl            String?             @map("image_url")
  isActive            Boolean             @default(true) @map("is_active")
  isPromo             Boolean             @default(false) @map("is_promo")
  promoPrice          Decimal?            @map("promo_price") @db.Decimal(10, 2)
  promoStartDate      DateTime?           @map("promo_start_date") @db.Timestamptz(6)
  promoEndDate        DateTime?           @map("promo_end_date") @db.Timestamptz(6)
  trackStock          Boolean             @default(false) @map("track_stock")
  stockQty            Int?                @map("stock_qty")
  dailyStockTemplate  Int?                @map("daily_stock_template")
  autoResetStock      Boolean             @default(false) @map("auto_reset_stock")
  lastStockResetAt    DateTime?           @map("last_stock_reset_at") @db.Timestamptz(6)
  createdByUserId     BigInt?             @map("created_by_user_id")
  updatedByUserId     BigInt?             @map("updated_by_user_id")
  deletedAt           DateTime?           @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId     BigInt?             @map("deleted_by_user_id")
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCategories     MenuAddonCategory[]
  category            MenuCategory?       @relation(fields: [categoryId], references: [id]) // Keep for backward compatibility
  merchant            Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  orderItems          OrderItem[]
  categories          MenuCategoryItem[]  // Many-to-many relation
  createdBy           User?               @relation("MenuCreatedBy", fields: [createdByUserId], references: [id])
  updatedBy           User?               @relation("MenuUpdatedBy", fields: [updatedByUserId], references: [id])
  deletedBy           User?               @relation("MenuDeletedBy", fields: [deletedByUserId], references: [id])

  @@index([merchantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([isPromo])
  @@index([deletedAt])
  @@map("menus")
}

model AddonCategory {
  id                  BigInt              @id @default(autoincrement())
  merchantId          BigInt              @map("merchant_id")
  name                String
  description         String?
  minSelection        Int                 @default(0) @map("min_selection")
  maxSelection        Int?                @map("max_selection")
  isActive            Boolean             @default(true) @map("is_active")
  createdByUserId     BigInt?             @map("created_by_user_id")
  updatedByUserId     BigInt?             @map("updated_by_user_id")
  deletedAt           DateTime?           @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId     BigInt?             @map("deleted_by_user_id")
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant            Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  addonItems          AddonItem[]
  menuAddonCategories MenuAddonCategory[]
  createdBy           User?               @relation("AddonCatCreatedBy", fields: [createdByUserId], references: [id])
  updatedBy           User?               @relation("AddonCatUpdatedBy", fields: [updatedByUserId], references: [id])
  deletedBy           User?               @relation("AddonCatDeletedBy", fields: [deletedByUserId], references: [id])

  @@index([merchantId])
  @@index([deletedAt])
  @@map("addon_categories")
}

model AddonItem {
  id                  BigInt           @id @default(autoincrement())
  addonCategoryId     BigInt           @map("addon_category_id")
  name                String
  description         String?
  price               Decimal          @default(0) @db.Decimal(10, 2)
  inputType           AddonInputType   @default(SELECT) @map("input_type")
  displayOrder        Int              @default(0) @map("display_order")
  isActive            Boolean          @default(true) @map("is_active")
  trackStock          Boolean          @default(false) @map("track_stock")
  stockQty            Int?             @map("stock_qty")
  dailyStockTemplate  Int?             @map("daily_stock_template")
  autoResetStock      Boolean          @default(false) @map("auto_reset_stock")
  lastStockResetAt    DateTime?        @map("last_stock_reset_at") @db.Timestamptz(6)
  createdByUserId     BigInt?          @map("created_by_user_id")
  updatedByUserId     BigInt?          @map("updated_by_user_id")
  deletedAt           DateTime?        @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId     BigInt?          @map("deleted_by_user_id")
  createdAt           DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCategory       AddonCategory    @relation(fields: [addonCategoryId], references: [id], onDelete: Cascade)
  orderItemAddons     OrderItemAddon[]
  createdBy           User?            @relation("AddonItemCreatedBy", fields: [createdByUserId], references: [id])
  updatedBy           User?            @relation("AddonItemUpdatedBy", fields: [updatedByUserId], references: [id])
  deletedBy           User?            @relation("AddonItemDeletedBy", fields: [deletedByUserId], references: [id])

  @@index([addonCategoryId])
  @@index([displayOrder])
  @@index([autoResetStock, lastStockResetAt])
  @@index([deletedAt])
  @@map("addon_items")
}

model MenuAddonCategory {
  menuId          BigInt        @map("menu_id")
  addonCategoryId BigInt        @map("addon_category_id")
  isRequired      Boolean       @default(false) @map("is_required")
  displayOrder    Int           @default(0) @map("display_order")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCategory   AddonCategory @relation(fields: [addonCategoryId], references: [id], onDelete: Cascade)
  menu            Menu          @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@id([menuId, addonCategoryId])
  @@index([menuId])
  @@index([addonCategoryId])
  @@index([displayOrder])
  @@map("menu_addon_categories")
}

model Order {
  id            BigInt               @id @default(autoincrement())
  merchantId    BigInt               @map("merchant_id")
  customerId    BigInt?              @map("customer_id")
  orderNumber   String               @map("order_number")
  customerName  String               @map("customer_name")
  customerEmail String               @map("customer_email")
  customerPhone String?              @map("customer_phone")
  orderType     OrderType            @map("order_type")
  tableNumber   String?              @map("table_number")
  status        OrderStatus          @default(PENDING)
  subtotal      Decimal              @db.Decimal(10, 2)
  taxAmount     Decimal              @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount   Decimal              @map("total_amount") @db.Decimal(10, 2)
  notes         String?
  qrCodeUrl     String?              @map("qr_code_url")
  placedAt      DateTime             @default(now()) @map("placed_at") @db.Timestamptz(6)
  createdAt     DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  orderItems    OrderItem[]
  statusHistory OrderStatusHistory[]
  customer      User?                @relation("CustomerOrders", fields: [customerId], references: [id])
  merchant      Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, orderNumber])
  @@index([merchantId])
  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@index([placedAt])
  @@map("orders")
}

model OrderItem {
  id        BigInt           @id @default(autoincrement())
  orderId   BigInt           @map("order_id")
  menuId    BigInt           @map("menu_id")
  menuName  String           @map("menu_name")
  menuPrice Decimal          @map("menu_price") @db.Decimal(10, 2)
  quantity  Int
  subtotal  Decimal          @db.Decimal(10, 2)
  notes     String?
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  addons    OrderItemAddon[]
  menu      Menu             @relation(fields: [menuId], references: [id])
  order     Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([menuId])
  @@map("order_items")
}

model OrderItemAddon {
  id          BigInt    @id @default(autoincrement())
  orderItemId BigInt    @map("order_item_id")
  addonItemId BigInt    @map("addon_item_id")
  addonName   String    @map("addon_name")
  addonPrice  Decimal   @map("addon_price") @db.Decimal(10, 2)
  quantity    Int
  subtotal    Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonItem   AddonItem @relation(fields: [addonItemId], references: [id])
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@index([addonItemId])
  @@map("order_item_addons")
}

model OrderStatusHistory {
  id              BigInt       @id @default(autoincrement())
  orderId         BigInt       @map("order_id")
  fromStatus      OrderStatus? @map("from_status")
  toStatus        OrderStatus  @map("to_status")
  changedByUserId BigInt?      @map("changed_by_user_id")
  note            String?
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  changedBy       User?        @relation(fields: [changedByUserId], references: [id])
  order           Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

enum UserRole {
  SUPER_ADMIN
  MERCHANT_OWNER
  MERCHANT_STAFF
  CUSTOMER
}

enum MerchantRole {
  OWNER
  STAFF
}

enum SessionStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum OrderType {
  DINE_IN
  TAKEAWAY
}

enum OrderStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  READY
  COMPLETED
  CANCELLED
}

enum AddonInputType {
  SELECT
  QTY
}
