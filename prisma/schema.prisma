generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  BigInt          @id @default(autoincrement())
  name                String
  email               String          @unique
  phone               String?
  passwordHash        String          @map("password_hash")
  profilePictureUrl   String?         @map("profile_picture_url")
  role                UserRole        @default(MERCHANT_STAFF)
  isActive            Boolean         @default(true) @map("is_active")
  mustChangePassword  Boolean         @default(false) @map("must_change_password")
  resetToken          String?         @map("reset_token")
  resetTokenExpiresAt DateTime?       @map("reset_token_expires_at") @db.Timestamptz(6)
  lastLoginAt         DateTime?       @map("last_login_at") @db.Timestamptz(6)
  createdAt           DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCatsCreated    AddonCategory[] @relation("AddonCatCreatedBy")
  addonCatsDeleted    AddonCategory[] @relation("AddonCatDeletedBy")
  addonCatsUpdated    AddonCategory[] @relation("AddonCatUpdatedBy")
  addonCatsRestored   AddonCategory[] @relation("AddonCatRestoredBy")
  addonItemsCreated   AddonItem[]     @relation("AddonItemCreatedBy")
  addonItemsDeleted   AddonItem[]     @relation("AddonItemDeletedBy")
  addonItemsUpdated   AddonItem[]     @relation("AddonItemUpdatedBy")
  addonItemsRestored  AddonItem[]     @relation("AddonItemRestoredBy")
  categoriesCreated   MenuCategory[]  @relation("CategoryCreatedBy")
  categoriesDeleted   MenuCategory[]  @relation("CategoryDeletedBy")
  categoriesUpdated   MenuCategory[]  @relation("CategoryUpdatedBy")
  categoriesRestored  MenuCategory[]  @relation("CategoryRestoredBy")
  menusCreated        Menu[]          @relation("MenuCreatedBy")
  menusDeleted        Menu[]          @relation("MenuDeletedBy")
  menusUpdated        Menu[]          @relation("MenuUpdatedBy")
  menusRestored       Menu[]          @relation("MenuRestoredBy")
  merchantUsers       MerchantUser[]
  paymentsRecorded    Payment[]       @relation("PaymentRecordedBy")
  preferences         UserPreference?
  sessions            UserSession[]
  notifications       UserNotification[]
  pushSubscriptions   PushSubscription[]
  stockPhotosUploaded StockPhoto[]       @relation("StockPhotoUploadedBy")
  deliveryOrdersAssigned Order[]          @relation("DeliveryDriver")
  influencerApprovalLogs InfluencerApprovalLog[] @relation("InfluencerApprovalActedBy")

  @@index([email])
  @@index([role])
  @@map("users")
}

model UserSession {
  id               BigInt        @id @default(autoincrement())
  userId           BigInt        @map("user_id")
  token            String        @unique
  deviceInfo       String?       @map("device_info")
  ipAddress        String?       @map("ip_address")
  status           SessionStatus @default(ACTIVE)
  expiresAt        DateTime      @map("expires_at") @db.Timestamptz(6)
  refreshExpiresAt DateTime?     @map("refresh_expires_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([status])
  @@map("user_sessions")
}

model UserPreference {
  id                    BigInt   @id @default(autoincrement())
  userId                BigInt   @unique @map("user_id")
  theme                 String   @default("light")
  language              String   @default("en")
  timezone              String   @default("Asia/Jakarta")
  dateFormat            String   @default("DD/MM/YYYY") @map("date_format")
  timeFormat            String   @default("24h") @map("time_format")
  currency              String   @default("AUD")
  emailNotifications    Boolean  @default(true) @map("email_notifications")
  orderNotifications    Boolean  @default(true) @map("order_notifications")
  marketingEmails       Boolean  @default(false) @map("marketing_emails")
  // Tutorial & Onboarding
  hasCompletedOnboarding Boolean  @default(false) @map("has_completed_onboarding")
  completedTutorials    String[] @default([]) @map("completed_tutorials") // Array of tutorial IDs
  lastHintDismissedAt   DateTime? @map("last_hint_dismissed_at") @db.Timestamptz(6)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_preferences")
}

// ============================================
// INFLUENCER (Referral Partner System)
// ============================================

model Influencer {
  id                  BigInt              @id @default(autoincrement())
  name                String
  email               String              @unique
  phone               String?
  passwordHash        String              @map("password_hash")
  referralCode        String              @unique @map("referral_code") // Their unique code for merchants to use
  country             String              @default("Indonesia") // For default currency
  defaultCurrency     String              @default("IDR") @map("default_currency")
  profilePictureUrl   String?             @map("profile_picture_url")
  isActive            Boolean             @default(true) @map("is_active")
  isApproved          Boolean             @default(false) @map("is_approved") // Needs admin approval
  approvedAt          DateTime?           @map("approved_at") @db.Timestamptz(6)
  approvedByUserId    BigInt?             @map("approved_by_user_id")
  resetToken          String?             @map("reset_token")
  resetTokenExpiresAt DateTime?           @map("reset_token_expires_at") @db.Timestamptz(6)
  lastLoginAt         DateTime?           @map("last_login_at") @db.Timestamptz(6)
  // Bank Details for Withdrawals
  bankNameIdr         String?             @map("bank_name_idr")
  bankAccountIdr      String?             @map("bank_account_idr")
  bankAccountNameIdr  String?             @map("bank_account_name_idr")
  bankNameAud         String?             @map("bank_name_aud")
  bankAccountAud      String?             @map("bank_account_aud")
  bankAccountNameAud  String?             @map("bank_account_name_aud")
  // Timestamps
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  sessions            InfluencerSession[]
  balances            InfluencerBalance[]
  transactions        InfluencerTransaction[]
  withdrawals         InfluencerWithdrawal[]
  approvalLogs        InfluencerApprovalLog[]
  referredMerchants   Merchant[]          @relation("MerchantReferredBy")

  @@index([email])
  @@index([referralCode])
  @@index([isActive])
  @@index([isApproved])
  @@map("influencers")
}

model InfluencerApprovalLog {
  id            BigInt                    @id @default(autoincrement())
  influencerId  BigInt                    @map("influencer_id")
  action        InfluencerApprovalAction
  reason        String?
  actedByUserId BigInt                    @map("acted_by_user_id")
  createdAt     DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)

  influencer    Influencer                @relation(fields: [influencerId], references: [id], onDelete: Cascade)
  actedByUser   User                      @relation("InfluencerApprovalActedBy", fields: [actedByUserId], references: [id], onDelete: Restrict)

  @@index([influencerId])
  @@index([actedByUserId])
  @@index([createdAt])
  @@map("influencer_approval_logs")
}

enum InfluencerApprovalAction {
  APPROVE
  REJECT
}

model InfluencerSession {
  id               BigInt        @id @default(autoincrement())
  influencerId     BigInt        @map("influencer_id")
  token            String        @unique
  deviceInfo       String?       @map("device_info")
  ipAddress        String?       @map("ip_address")
  status           SessionStatus @default(ACTIVE)
  expiresAt        DateTime      @map("expires_at") @db.Timestamptz(6)
  refreshExpiresAt DateTime?     @map("refresh_expires_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  influencer       Influencer    @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([influencerId])
  @@index([token])
  @@index([status])
  @@map("influencer_sessions")
}

model InfluencerBalance {
  id               BigInt              @id @default(autoincrement())
  influencerId     BigInt              @map("influencer_id")
  currency         String              @default("IDR") // IDR or AUD
  balance          Decimal             @default(0) @db.Decimal(12, 2)
  totalEarned      Decimal             @default(0) @map("total_earned") @db.Decimal(12, 2)
  totalWithdrawn   Decimal             @default(0) @map("total_withdrawn") @db.Decimal(12, 2)
  createdAt        DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  influencer       Influencer          @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@unique([influencerId, currency])
  @@index([influencerId])
  @@map("influencer_balances")
}

model InfluencerTransaction {
  id               BigInt                    @id @default(autoincrement())
  influencerId     BigInt                    @map("influencer_id")
  merchantId       BigInt?                   @map("merchant_id") // Which merchant generated this commission
  type             InfluencerTransactionType
  currency         String                    @default("IDR")
  amount           Decimal                   @db.Decimal(12, 2)
  balanceBefore    Decimal                   @map("balance_before") @db.Decimal(12, 2)
  balanceAfter     Decimal                   @map("balance_after") @db.Decimal(12, 2)
  description      String?
  // For commission: track what generated it
  paymentRequestId BigInt?                   @map("payment_request_id")
  isFirstPayment   Boolean                   @default(false) @map("is_first_payment") // First payment from merchant gets higher commission
  commissionRate   Decimal?                  @map("commission_rate") @db.Decimal(5, 2) // The rate used for this transaction
  createdAt        DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)

  influencer       Influencer                @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([influencerId])
  @@index([merchantId])
  @@index([type])
  @@index([createdAt])
  @@map("influencer_transactions")
}

model InfluencerWithdrawal {
  id               BigInt                      @id @default(autoincrement())
  influencerId     BigInt                      @map("influencer_id")
  currency         String                      @default("IDR")
  amount           Decimal                     @db.Decimal(12, 2)
  status           InfluencerWithdrawalStatus  @default(PENDING)
  // Bank details (copied from influencer at time of request)
  bankName         String                      @map("bank_name")
  bankAccountNumber String                     @map("bank_account_number")
  bankAccountName  String                      @map("bank_account_name")
  // Admin processing
  processedAt      DateTime?                   @map("processed_at") @db.Timestamptz(6)
  processedByUserId BigInt?                    @map("processed_by_user_id")
  transferProofUrl String?                     @map("transfer_proof_url")
  rejectedAt       DateTime?                   @map("rejected_at") @db.Timestamptz(6)
  rejectionReason  String?                     @map("rejection_reason")
  notes            String?
  createdAt        DateTime                    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime                    @updatedAt @map("updated_at") @db.Timestamptz(6)

  influencer       Influencer                  @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  @@index([influencerId])
  @@index([status])
  @@index([createdAt])
  @@map("influencer_withdrawals")
}

enum InfluencerTransactionType {
  COMMISSION_FIRST    // First-time commission from merchant payment
  COMMISSION_RECURRING // Recurring commission from merchant payment
  WITHDRAWAL          // Withdrawal deduction
  ADJUSTMENT          // Admin adjustment
}

enum InfluencerWithdrawalStatus {
  PENDING             // Waiting for admin processing
  PROCESSING          // Admin is processing
  COMPLETED           // Transfer completed
  REJECTED            // Rejected by admin
}

// ============================================
// CUSTOMER (Separate from Admin/Merchant Users)
// ============================================

model Customer {
  id                  BigInt            @id @default(autoincrement())
  name                String
  email               String            @unique
  phone               String?
  passwordHash        String?           @map("password_hash")
  isActive            Boolean           @default(true) @map("is_active")
  mustChangePassword  Boolean           @default(false) @map("must_change_password")
  resetToken          String?           @map("reset_token")
  resetTokenExpiresAt DateTime?         @map("reset_token_expires_at") @db.Timestamptz(6)
  lastLoginAt         DateTime?         @map("last_login_at") @db.Timestamptz(6)
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  // Customer segmentation fields
  totalOrders         Int               @default(0) @map("total_orders")
  totalSpent          Decimal           @default(0) @map("total_spent") @db.Decimal(10, 2)
  lastOrderAt         DateTime?         @map("last_order_at") @db.Timestamptz(6)
  
  orders              Order[]
  reservations        Reservation[]
  sessions            CustomerSession[]
  favorites           CustomerFavorite[]
  groupOrderParticipations GroupOrderParticipant[]
  pushSubscriptions   CustomerPushSubscription[]

  @@index([email])
  @@index([phone])
  @@index([totalOrders])
  @@index([lastOrderAt])
  @@map("customers")
}

// Customer Favorite Menus
model CustomerFavorite {
  id          BigInt   @id @default(autoincrement())
  customerId  BigInt   @map("customer_id")
  merchantId  BigInt   @map("merchant_id")
  menuId      BigInt   @map("menu_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, menuId])
  @@index([customerId])
  @@index([merchantId])
  @@index([menuId])
  @@map("customer_favorites")
}

model CustomerSession {
  id               BigInt        @id @default(autoincrement())
  customerId       BigInt        @map("customer_id")
  token            String        @unique
  deviceInfo       String?       @map("device_info")
  ipAddress        String?       @map("ip_address")
  status           SessionStatus @default(ACTIVE)
  expiresAt        DateTime      @map("expires_at") @db.Timestamptz(6)
  refreshExpiresAt DateTime?     @map("refresh_expires_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  customer         Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([token])
  @@index([status])
  @@map("customer_sessions")
}

model MerchantUser {
  id         BigInt       @id @default(autoincrement())
  merchantId BigInt       @map("merchant_id")
  userId     BigInt       @map("user_id")
  role       MerchantRole @default(STAFF)
  // Staff Permissions - JSON array of permission keys
  // null means all permissions (for OWNER), empty array means no permissions
  // Example: ["orders", "menu", "categories", "stock"]
  permissions String[]    @default([])
  isActive    Boolean     @default(true) @map("is_active")
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([merchantId, userId])
  @@index([merchantId])
  @@index([userId])
  @@index([isActive])
  @@map("merchant_users")
}

model Merchant {
  id                     BigInt                @id @default(autoincrement())
  code                   String                @unique
  name                   String
  email                  String
  phone                  String?
  address                String?
  city                   String?
  state                  String?
  postalCode             String?               @map("postal_code")
  country                String                @default("Australia")
  logoUrl                String?               @map("logo_url")
  bannerUrl              String?               @map("banner_url")
  mapUrl                 String?               @map("map_url")
  description            String?
  isActive               Boolean               @default(true) @map("is_active")
  enableTax              Boolean               @default(false) @map("enable_tax")
  taxPercentage          Decimal?              @map("tax_percentage") @db.Decimal(5, 2)
  enableServiceCharge    Boolean               @default(false) @map("enable_service_charge")
  serviceChargePercent   Decimal?              @map("service_charge_percent") @db.Decimal(5, 2)
  enablePackagingFee     Boolean               @default(false) @map("enable_packaging_fee")
  packagingFeeAmount     Decimal?              @map("packaging_fee_amount") @db.Decimal(10, 2)
  currency               String                @default("AUD")
  createdAt              DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  isOpen                 Boolean               @default(true) @map("is_open")
  isManualOverride       Boolean               @default(false) @map("is_manual_override") // When true, isOpen overrides schedule
  isDineInEnabled        Boolean               @default(true) @map("is_dine_in_enabled")
  isTakeawayEnabled      Boolean               @default(false) @map("is_takeaway_enabled")
  dineInLabel            String?               @map("dine_in_label")
  takeawayLabel          String?               @map("takeaway_label")
  deliveryLabel          String?               @map("delivery_label")
  dineInScheduleStart    String?               @map("dine_in_schedule_start")
  dineInScheduleEnd      String?               @map("dine_in_schedule_end")
  takeawayScheduleStart  String?               @map("takeaway_schedule_start")
  takeawayScheduleEnd    String?               @map("takeaway_schedule_end")

  // Optional global delivery schedule (HH:MM)
  deliveryScheduleStart  String?               @map("delivery_schedule_start")
  deliveryScheduleEnd    String?               @map("delivery_schedule_end")
  totalTables            Int?                  @map("total_tables")
  requireTableNumberForDineIn Boolean          @default(false) @map("require_table_number_for_dine_in")
  latitude               Decimal?              @db.Decimal(10, 8)
  longitude              Decimal?              @db.Decimal(11, 8)
  timezone               String                @default("Australia/Sydney")

  // Reservations
  isReservationEnabled       Boolean            @default(false) @map("is_reservation_enabled")
  reservationMenuRequired    Boolean            @default(false) @map("reservation_menu_required")
  reservationMinItemCount    Int                @default(0) @map("reservation_min_item_count")

  // Scheduled Orders (pickup/delivery scheduled time)
  // Same-day in merchant timezone; enforced in /api/public/orders
  isScheduledOrderEnabled    Boolean            @default(false) @map("is_scheduled_order_enabled")

  // Delivery settings (default OFF)
  isDeliveryEnabled          Boolean              @default(false) @map("is_delivery_enabled")
  enforceDeliveryZones       Boolean              @default(true) @map("enforce_delivery_zones")
  deliveryMaxDistanceKm      Decimal?             @map("delivery_max_distance_km") @db.Decimal(10, 3)
  deliveryFeeBase            Decimal?             @map("delivery_fee_base") @db.Decimal(10, 2)
  deliveryFeePerKm           Decimal?             @map("delivery_fee_per_km") @db.Decimal(10, 2)
  deliveryFeeMin             Decimal?             @map("delivery_fee_min") @db.Decimal(10, 2)
  deliveryFeeMax             Decimal?             @map("delivery_fee_max") @db.Decimal(10, 2)
  addonCategories        AddonCategory[]
  menuCategories         MenuCategory[]
  menus                  Menu[]
  openingHours           MerchantOpeningHour[]
  modeSchedules          MerchantModeSchedule[]
  specialHours           MerchantSpecialHour[]
  merchantUsers          MerchantUser[]
  orders                 Order[]
  reservations           Reservation[]
  deliveryZones          MerchantDeliveryZone[]
  menuBooks              MenuBook[]
  specialPrices          SpecialPrice[]
  // Subscription system relations
  subscription           MerchantSubscription?
  merchantBalance        MerchantBalance?
  paymentRequests        PaymentRequest[]
  notificationLogs       NotificationLog[]
  userNotifications      UserNotification[]
  pushSubscriptions      PushSubscription[]
  // Referral/Influencer tracking
  referralCodeUsed       String?               @map("referral_code_used")
  referredByInfluencerId BigInt?               @map("referred_by_influencer_id")
  referredByInfluencer   Influencer?           @relation("MerchantReferredBy", fields: [referredByInfluencerId], references: [id])
  hasGivenFirstCommission Boolean              @default(false) @map("has_given_first_commission") // Track if first commission was given
  // PIN for order deletion (4 digits, hashed)
  deletePin              String?               @map("delete_pin")
  // Group Order relation
  groupOrderSessions     GroupOrderSession[]
  
  // Receipt Template Settings (JSON field with customization options)
  receiptSettings        Json?                 @map("receipt_settings") @db.JsonB

  // Feature flags (structured JSON) for safe onboarding of new features
  // Example: { "reservations": { "enabled": true } }
  features               Json?                 @map("features") @db.JsonB

  // Stock Alert Settings
  stockAlertEnabled         Boolean              @default(true) @map("stock_alert_enabled")
  defaultLowStockThreshold  Int                  @default(5) @map("default_low_stock_threshold")
  orderFeedbacks         OrderFeedback[]

  @@index([code])
  @@index([isActive])
  @@index([referredByInfluencerId])
  @@map("merchants")
}

model MerchantDeliveryZone {
  id         BigInt           @id @default(autoincrement())
  merchantId BigInt           @map("merchant_id")
  name       String
  type       DeliveryZoneType
  // Radius zone
  radiusKm   Decimal?         @map("radius_km") @db.Decimal(10, 3)
  // Polygon zone (array of {lat,lng} points) stored as JSON
  polygon    Json?            @db.JsonB
  isActive   Boolean          @default(true) @map("is_active")
  createdAt  DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant   Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([isActive])
  @@map("merchant_delivery_zones")
}

model MerchantOpeningHour {
  id         BigInt   @id @default(autoincrement())
  merchantId BigInt   @map("merchant_id")
  dayOfWeek  Int      @map("day_of_week")
  openTime   String?  @map("open_time")
  closeTime  String?  @map("close_time")
  isClosed   Boolean  @default(false) @map("is_closed")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, dayOfWeek])
  @@map("merchant_opening_hours")
}

// ============================================
// PER-DAY MODE SCHEDULES
// Different mode availability for each day of week
// ============================================

model MerchantModeSchedule {
  id         BigInt    @id @default(autoincrement())
  merchantId BigInt    @map("merchant_id")
  mode       OrderType @default(DINE_IN)
  dayOfWeek  Int       @map("day_of_week") // 0=Sunday, 6=Saturday
  startTime  String    @map("start_time") // HH:MM format
  endTime    String    @map("end_time") // HH:MM format
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, mode, dayOfWeek])
  @@index([merchantId])
  @@index([dayOfWeek])
  @@map("merchant_mode_schedules")
}

// ============================================
// HOLIDAY / SPECIAL HOURS
// Override regular hours for specific dates
// ============================================

model MerchantSpecialHour {
  id                 BigInt    @id @default(autoincrement())
  merchantId         BigInt    @map("merchant_id")
  date               DateTime  @map("date") @db.Date
  name               String?   // "Christmas Day", "New Year's Eve"
  isClosed           Boolean   @default(false) @map("is_closed")
  openTime           String?   @map("open_time")
  closeTime          String?   @map("close_time")
  // Mode overrides for this day
  isDineInEnabled    Boolean?  @map("is_dine_in_enabled")
  isTakeawayEnabled  Boolean?  @map("is_takeaway_enabled")
  isDeliveryEnabled  Boolean?  @map("is_delivery_enabled")
  dineInStartTime    String?   @map("dine_in_start_time")
  dineInEndTime      String?   @map("dine_in_end_time")
  takeawayStartTime  String?   @map("takeaway_start_time")
  takeawayEndTime    String?   @map("takeaway_end_time")
  deliveryStartTime  String?   @map("delivery_start_time")
  deliveryEndTime    String?   @map("delivery_end_time")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant           Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, date])
  @@index([merchantId])
  @@index([date])
  @@map("merchant_special_hours")
}

model MenuCategory {
  id              BigInt             @id @default(autoincrement())
  merchantId      BigInt             @map("merchant_id")
  name            String
  description     String?
  sortOrder       Int                @default(0) @map("sort_order")
  isActive        Boolean            @default(true) @map("is_active")
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdByUserId  BigInt?            @map("created_by_user_id")
  deletedAt        DateTime?          @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId  BigInt?            @map("deleted_by_user_id")
  updatedByUserId  BigInt?            @map("updated_by_user_id")
  restoredAt       DateTime?          @map("restored_at") @db.Timestamptz(6)
  restoredByUserId BigInt?            @map("restored_by_user_id")
  createdBy        User?              @relation("CategoryCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy        User?              @relation("CategoryDeletedBy", fields: [deletedByUserId], references: [id])
  merchant         Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  updatedBy        User?              @relation("CategoryUpdatedBy", fields: [updatedByUserId], references: [id])
  restoredBy       User?              @relation("CategoryRestoredBy", fields: [restoredByUserId], references: [id])
  menuItems        MenuCategoryItem[]
  menus            Menu[]

  @@index([merchantId])
  @@index([sortOrder])
  @@index([deletedAt])
  @@map("menu_categories")
}

model MenuCategoryItem {
  id         BigInt       @id @default(autoincrement())
  menuId     BigInt       @map("menu_id")
  categoryId BigInt       @map("category_id")
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  category   MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  menu       Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([menuId, categoryId])
  @@index([menuId])
  @@index([categoryId])
  @@map("menu_category_items")
}

model Menu {
  id                 BigInt              @id @default(autoincrement())
  merchantId         BigInt              @map("merchant_id")
  categoryId         BigInt?             @map("category_id")
  name               String
  description        String?
  price              Decimal             @db.Decimal(10, 2)
  imageUrl           String?             @map("image_url")
  imageThumbUrl      String?             @map("image_thumb_url")
  imageThumbMeta     Json?               @map("image_thumb_meta")
  isActive           Boolean             @default(true) @map("is_active")
  // Note: Promo fields removed - use SpecialPrice/SpecialPriceItem tables instead
  trackStock         Boolean             @default(false) @map("track_stock")
  stockQty           Int?                @map("stock_qty")
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  autoResetStock     Boolean             @default(false) @map("auto_reset_stock")
  dailyStockTemplate Int?                @map("daily_stock_template")
  lastStockResetAt   DateTime?           @map("last_stock_reset_at") @db.Timestamptz(6)
  createdByUserId    BigInt?             @map("created_by_user_id")
  deletedAt          DateTime?           @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId    BigInt?             @map("deleted_by_user_id")
  updatedByUserId    BigInt?             @map("updated_by_user_id")
  restoredAt         DateTime?           @map("restored_at") @db.Timestamptz(6)
  restoredByUserId   BigInt?             @map("restored_by_user_id")
  isSpicy            Boolean             @default(false) @map("is_spicy")
  isBestSeller       Boolean             @default(false) @map("is_best_seller")
  isSignature        Boolean             @default(false) @map("is_signature")
  isRecommended      Boolean             @default(false) @map("is_recommended")
  // Menu Scheduling - Auto-enable/disable based on time
  scheduleEnabled    Boolean             @default(false) @map("schedule_enabled")
  scheduleStartTime  String?             @map("schedule_start_time") // HH:MM format
  scheduleEndTime    String?             @map("schedule_end_time") // HH:MM format
  scheduleDays       Int[]               @default([]) @map("schedule_days") // 0=Sun, 1=Mon, ... 6=Sat
  // Cost for profit calculation
  costPrice          Decimal?            @map("cost_price") @db.Decimal(10, 2)
  // Stock alert threshold (if null, use merchant default)
  lowStockThreshold  Int?                @map("low_stock_threshold")
  addonCategories    MenuAddonCategory[]
  categories         MenuCategoryItem[]
  category           MenuCategory?       @relation(fields: [categoryId], references: [id])
  createdBy          User?               @relation("MenuCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy          User?               @relation("MenuDeletedBy", fields: [deletedByUserId], references: [id])
  merchant           Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  updatedBy          User?               @relation("MenuUpdatedBy", fields: [updatedByUserId], references: [id])
  restoredBy         User?               @relation("MenuRestoredBy", fields: [restoredByUserId], references: [id])
  orderItems         OrderItem[]
  menuBookItems      MenuBookItem[]
  specialPriceItems  SpecialPriceItem[]

  @@index([merchantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([scheduleEnabled])
  @@index([name]) // For search optimization
  @@map("menus")
}

model AddonCategory {
  id                  BigInt              @id @default(autoincrement())
  merchantId          BigInt              @map("merchant_id")
  name                String
  description         String?
  minSelection        Int                 @default(0) @map("min_selection")
  maxSelection        Int?                @map("max_selection")
  isActive            Boolean             @default(true) @map("is_active")
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdByUserId     BigInt?             @map("created_by_user_id")
  deletedAt           DateTime?           @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId     BigInt?             @map("deleted_by_user_id")
  updatedByUserId     BigInt?             @map("updated_by_user_id")
  restoredAt          DateTime?           @map("restored_at") @db.Timestamptz(6)
  restoredByUserId    BigInt?             @map("restored_by_user_id")
  createdBy           User?               @relation("AddonCatCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy           User?               @relation("AddonCatDeletedBy", fields: [deletedByUserId], references: [id])
  merchant            Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  updatedBy           User?               @relation("AddonCatUpdatedBy", fields: [updatedByUserId], references: [id])
  restoredBy          User?               @relation("AddonCatRestoredBy", fields: [restoredByUserId], references: [id])
  addonItems          AddonItem[]
  menuAddonCategories MenuAddonCategory[]

  @@index([merchantId])
  @@index([deletedAt])
  @@map("addon_categories")
}

model AddonItem {
  id                 BigInt           @id @default(autoincrement())
  addonCategoryId    BigInt           @map("addon_category_id")
  name               String
  description        String?
  price              Decimal          @default(0) @db.Decimal(10, 2)
  isActive           Boolean          @default(true) @map("is_active")
  trackStock         Boolean          @default(false) @map("track_stock")
  stockQty           Int?             @map("stock_qty")
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  inputType          AddonInputType   @default(SELECT) @map("input_type")
  displayOrder       Int              @default(0) @map("display_order")
  autoResetStock     Boolean          @default(false) @map("auto_reset_stock")
  createdByUserId    BigInt?          @map("created_by_user_id")
  dailyStockTemplate Int?             @map("daily_stock_template")
  deletedAt          DateTime?        @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId    BigInt?          @map("deleted_by_user_id")
  lastStockResetAt   DateTime?        @map("last_stock_reset_at") @db.Timestamptz(6)
  updatedByUserId    BigInt?          @map("updated_by_user_id")
  restoredAt         DateTime?        @map("restored_at") @db.Timestamptz(6)
  restoredByUserId   BigInt?          @map("restored_by_user_id")
  addonCategory      AddonCategory    @relation(fields: [addonCategoryId], references: [id], onDelete: Cascade)
  createdBy          User?            @relation("AddonItemCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy          User?            @relation("AddonItemDeletedBy", fields: [deletedByUserId], references: [id])
  updatedBy          User?            @relation("AddonItemUpdatedBy", fields: [updatedByUserId], references: [id])
  restoredBy         User?            @relation("AddonItemRestoredBy", fields: [restoredByUserId], references: [id])
  orderItemAddons    OrderItemAddon[]

  @@index([addonCategoryId])
  @@index([displayOrder])
  @@index([autoResetStock, lastStockResetAt])
  @@index([deletedAt])
  @@map("addon_items")
}

model MenuAddonCategory {
  menuId          BigInt        @map("menu_id")
  addonCategoryId BigInt        @map("addon_category_id")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  displayOrder    Int           @default(0) @map("display_order")
  isRequired      Boolean       @default(false) @map("is_required")
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCategory   AddonCategory @relation(fields: [addonCategoryId], references: [id], onDelete: Cascade)
  menu            Menu          @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@id([menuId, addonCategoryId])
  @@index([menuId])
  @@index([addonCategoryId])
  @@index([displayOrder])
  @@map("menu_addon_categories")
}

model Order {
  id                   BigInt      @id @default(autoincrement())
  merchantId           BigInt      @map("merchant_id")
  customerId           BigInt?     @map("customer_id")
  orderNumber          String      @map("order_number")
  orderType            OrderType   @map("order_type")
  tableNumber          String?     @map("table_number")
  status               OrderStatus @default(PENDING)

  // Scheduled Orders (same-day in merchant timezone)
  isScheduled          Boolean     @default(false) @map("is_scheduled")
  scheduledDate        String?     @map("scheduled_date") // YYYY-MM-DD (merchant timezone)
  scheduledTime        String?     @map("scheduled_time") // HH:MM (merchant timezone)

  // Stock is deducted immediately for normal orders, and at ACCEPTED for scheduled orders.
  stockDeductedAt      DateTime?   @map("stock_deducted_at") @db.Timestamptz(6)

  // Delivery-specific fields (only used when orderType = DELIVERY)
  deliveryStatus        DeliveryStatus? @map("delivery_status")
  deliveryUnit          String?         @map("delivery_unit")
  deliveryBuildingName  String?         @map("delivery_building_name")
  deliveryBuildingNumber String?        @map("delivery_building_number")
  deliveryFloor         String?         @map("delivery_floor")
  deliveryInstructions  String?         @map("delivery_instructions") @db.Text
  deliveryAddress       String?         @map("delivery_address") @db.Text
  deliveryStreetLine    String?         @map("delivery_street_line")
  deliverySuburb        String?         @map("delivery_suburb")
  deliveryCity          String?         @map("delivery_city")
  deliveryState         String?         @map("delivery_state")
  deliveryPostcode      String?         @map("delivery_postcode")
  deliveryCountry       String?         @map("delivery_country")
  deliveryLatitude      Decimal?        @map("delivery_latitude") @db.Decimal(10, 8)
  deliveryLongitude     Decimal?        @map("delivery_longitude") @db.Decimal(11, 8)
  deliveryDistanceKm    Decimal?        @map("delivery_distance_km") @db.Decimal(10, 3)
  deliveryFeeAmount     Decimal         @default(0) @map("delivery_fee_amount") @db.Decimal(10, 2)
  deliveryDriverUserId  BigInt?         @map("delivery_driver_user_id")
  deliveryAssignedAt    DateTime?       @map("delivery_assigned_at") @db.Timestamptz(6)
  deliveryDeliveredAt   DateTime?       @map("delivery_delivered_at") @db.Timestamptz(6)
  subtotal             Decimal     @db.Decimal(10, 2)
  taxAmount            Decimal     @default(0) @map("tax_amount") @db.Decimal(10, 2)
  serviceChargeAmount  Decimal     @default(0) @map("service_charge_amount") @db.Decimal(10, 2)
  packagingFeeAmount   Decimal     @default(0) @map("packaging_fee") @db.Decimal(10, 2)
  totalAmount          Decimal     @map("total_amount") @db.Decimal(10, 2)
  notes                String?
  // Admin-only note (NOT shown to customers)
  adminNote            String?     @map("admin_note") @db.Text

  // Combined note for kitchen/kanban display stored in DB
  // Format: "<customer notes> - admin: <admin note>"
  kitchenNotes         String?     @map("kitchen_notes") @db.Text
  placedAt             DateTime    @default(now()) @map("placed_at") @db.Timestamptz(6)
  createdAt            DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  actualReadyAt        DateTime?   @map("actual_ready_at") @db.Timestamptz(6)
  cancelReason         String?     @map("cancel_reason")
  cancelledAt          DateTime?   @map("cancelled_at") @db.Timestamptz(6)
  completedAt          DateTime?   @map("completed_at") @db.Timestamptz(6)
  estimatedReadyAt     DateTime?   @map("estimated_ready_at") @db.Timestamptz(6)
  orderItems           OrderItem[]
  customer             Customer?   @relation(fields: [customerId], references: [id])
  reservation          Reservation?
  merchant             Merchant    @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  payment              Payment?
  groupOrderSession    GroupOrderSession?
  deliveryDriver        User?       @relation("DeliveryDriver", fields: [deliveryDriverUserId], references: [id])

  @@unique([merchantId, orderNumber])
  @@index([merchantId])
  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@index([placedAt])
  @@index([estimatedReadyAt])
  @@index([isScheduled])
  @@index([scheduledDate])
  @@index([scheduledTime])
  @@index([stockDeductedAt])
  @@index([deliveryDriverUserId])
  @@index([deliveryStatus])
  @@map("orders")
}

model Reservation {
  id               BigInt            @id @default(autoincrement())
  merchantId       BigInt            @map("merchant_id")
  customerId       BigInt            @map("customer_id")
  status           ReservationStatus @default(PENDING)
  partySize        Int               @map("party_size")
  reservationDate  String            @map("reservation_date") // YYYY-MM-DD (merchant timezone)
  reservationTime  String            @map("reservation_time") // HH:MM (merchant timezone)
  tableNumber      String?           @map("table_number")
  notes            String?           @db.Text

  // Optional preorder payload (items/addons) stored as JSON
  preorder         Json?             @map("preorder") @db.JsonB

  // If accepted, we create an Order and link it here.
  orderId          BigInt?           @unique @map("order_id")

  acceptedAt       DateTime?         @map("accepted_at") @db.Timestamptz(6)
  cancelledAt      DateTime?         @map("cancelled_at") @db.Timestamptz(6)
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant         Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  order            Order?            @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([merchantId])
  @@index([customerId])
  @@index([status])
  @@index([reservationDate])
  @@index([reservationTime])
  @@map("reservations")
}

model OrderItem {
  id                BigInt               @id @default(autoincrement())
  orderId           BigInt               @map("order_id")
  menuId            BigInt               @map("menu_id")
  menuName          String               @map("menu_name")
  menuPrice         Decimal              @map("menu_price") @db.Decimal(10, 2)
  quantity          Int
  subtotal          Decimal              @db.Decimal(10, 2)
  notes             String?
  createdAt         DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  addons            OrderItemAddon[]
  menu              Menu                 @relation(fields: [menuId], references: [id])
  order             Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)
  groupOrderDetails GroupOrderDetail[]   // Link to group order participant details

  @@index([orderId])
  @@index([menuId])
  @@map("order_items")
}

model OrderItemAddon {
  id          BigInt    @id @default(autoincrement())
  orderItemId BigInt    @map("order_item_id")
  addonItemId BigInt    @map("addon_item_id")
  addonName   String    @map("addon_name")
  addonPrice  Decimal   @map("addon_price") @db.Decimal(10, 2)
  quantity    Int
  subtotal    Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonItem   AddonItem @relation(fields: [addonItemId], references: [id])
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@index([addonItemId])
  @@map("order_item_addons")
}

model Payment {
  id                   BigInt        @id @default(autoincrement())
  orderId              BigInt        @unique @map("order_id")
  amount               Decimal       @db.Decimal(10, 2)
  paymentMethod        PaymentMethod @map("payment_method")
  status               PaymentStatus @default(PENDING)
  paidByUserId         BigInt?       @map("paid_by_user_id")
  paidAt               DateTime?     @map("paid_at") @db.Timestamptz(6)
  gatewayProvider      String?       @map("gateway_provider")
  gatewayTransactionId String?       @map("gateway_transaction_id")
  gatewayStatus        String?       @map("gateway_status")
  gatewayResponse      Json?         @map("gateway_response")
  gatewayCallbackAt    DateTime?     @map("gateway_callback_at") @db.Timestamptz(6)
  notes                String?
  metadata             Json?
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  order                Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paidBy               User?         @relation("PaymentRecordedBy", fields: [paidByUserId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([paymentMethod])
  @@index([gatewayTransactionId])
  @@index([paidAt])
  @@map("payments")
}

// ============================================
// ORDER FEEDBACK (Customer Reviews)
// ============================================

model OrderFeedback {
  id                     BigInt   @id @default(autoincrement())
  orderNumber            String   @unique @map("order_number")
  merchantId             BigInt   @map("merchant_id")
  
  // Ratings (1-5 stars)
  overallRating          Int      @map("overall_rating")    // Required
  serviceRating          Int?     @map("service_rating")    // Optional
  foodRating             Int?     @map("food_rating")       // Optional
  
  // Additional feedback
  comment                String?  @db.Text
  
  // Order completion time in minutes (calculated from order data)
  orderCompletionMinutes Int?     @map("order_completion_minutes")
  
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  merchant               Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  @@index([merchantId])
  @@index([createdAt])
  @@index([overallRating])
  @@map("order_feedbacks")
}

// ============================================
// MENU BOOKS & SPECIAL PRICES
// ============================================

model MenuBook {
  id            BigInt         @id @default(autoincrement())
  merchantId    BigInt         @map("merchant_id")
  name          String
  description   String?
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant      Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  items         MenuBookItem[]
  specialPrices SpecialPrice[]

  @@index([merchantId])
  @@index([isActive])
  @@map("menu_books")
}

model MenuBookItem {
  id          BigInt   @id @default(autoincrement())
  menuBookId  BigInt   @map("menu_book_id")
  menuId      BigInt   @map("menu_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  menuBook    MenuBook @relation(fields: [menuBookId], references: [id], onDelete: Cascade)
  menu        Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([menuBookId, menuId])
  @@index([menuBookId])
  @@index([menuId])
  @@map("menu_book_items")
}

model SpecialPrice {
  id             BigInt             @id @default(autoincrement())
  merchantId     BigInt             @map("merchant_id")
  menuBookId     BigInt             @map("menu_book_id")
  name           String
  startDate      DateTime           @map("start_date") @db.Date
  endDate        DateTime           @map("end_date") @db.Date
  applicableDays Int[]              @map("applicable_days")
  isAllDay       Boolean            @default(true) @map("is_all_day")
  startTime      String?            @map("start_time")
  endTime        String?            @map("end_time")
  isActive       Boolean            @default(true) @map("is_active")
  createdAt      DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant       Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  menuBook       MenuBook           @relation(fields: [menuBookId], references: [id], onDelete: Cascade)
  priceItems     SpecialPriceItem[]

  @@index([merchantId])
  @@index([menuBookId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("special_prices")
}

model SpecialPriceItem {
  id             BigInt       @id @default(autoincrement())
  specialPriceId BigInt       @map("special_price_id")
  menuId         BigInt       @map("menu_id")
  promoPrice     Decimal      @map("promo_price") @db.Decimal(10, 2)
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  specialPrice   SpecialPrice @relation(fields: [specialPriceId], references: [id], onDelete: Cascade)
  menu           Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([specialPriceId, menuId])
  @@index([specialPriceId])
  @@index([menuId])
  @@map("special_price_items")
}

// ============================================
// SUBSCRIPTION SYSTEM
// ============================================

model SubscriptionPlan {
  id                  BigInt   @id @default(autoincrement())
  planKey             String   @unique @map("plan_key")
  displayName         String   @map("display_name")
  description         String?
  // Trial settings
  trialDays           Int      @default(30) @map("trial_days")
  // Monthly subscription days (default 31)
  monthlyDays         Int      @default(31) @map("monthly_days")
  // Grace period days (for expired trials/subscriptions before suspension)
  gracePeriodDays     Int      @default(3) @map("grace_period_days")
  // IDR Pricing
  depositMinimumIdr   Decimal  @default(100000) @map("deposit_minimum_idr") @db.Decimal(12, 2)
  orderFeeIdr         Decimal  @default(250) @map("order_fee_idr") @db.Decimal(12, 2)
  monthlyPriceIdr     Decimal  @default(100000) @map("monthly_price_idr") @db.Decimal(12, 2)
  // AUD Pricing
  depositMinimumAud   Decimal  @default(15) @map("deposit_minimum_aud") @db.Decimal(12, 2)
  orderFeeAud         Decimal  @default(0.04) @map("order_fee_aud") @db.Decimal(12, 2)
  monthlyPriceAud     Decimal  @default(15) @map("monthly_price_aud") @db.Decimal(12, 2)
  // Bank Account Info (for manual transfer)
  bankNameIdr         String?  @map("bank_name_idr")
  bankAccountIdr      String?  @map("bank_account_idr")
  bankAccountNameIdr  String?  @map("bank_account_name_idr")
  bankNameAud         String?  @map("bank_name_aud")
  bankAccountAud      String?  @map("bank_account_aud")
  bankAccountNameAud  String?  @map("bank_account_name_aud")
  // Influencer Commission Settings
  influencerFirstCommissionPercent  Decimal  @default(10) @map("influencer_first_commission_percent") @db.Decimal(5, 2)
  influencerRecurringCommissionPercent  Decimal  @default(5) @map("influencer_recurring_commission_percent") @db.Decimal(5, 2)
  influencerMinWithdrawalIdr      Decimal  @default(100000) @map("influencer_min_withdrawal_idr") @db.Decimal(12, 2)
  influencerMinWithdrawalAud      Decimal  @default(20) @map("influencer_min_withdrawal_aud") @db.Decimal(12, 2)
  // Admin
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("subscription_plans")
}

model MerchantSubscription {
  id                  BigInt             @id @default(autoincrement())
  merchantId          BigInt             @unique @map("merchant_id")
  type                SubscriptionType   @default(TRIAL)
  status              SubscriptionStatus @default(ACTIVE)
  // Trial tracking
  trialStartedAt      DateTime?          @map("trial_started_at") @db.Timestamptz(6)
  trialEndsAt         DateTime?          @map("trial_ends_at") @db.Timestamptz(6)
  // Subscription period (for monthly)
  currentPeriodStart  DateTime?          @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd    DateTime?          @map("current_period_end") @db.Timestamptz(6)
  // Suspension info
  suspendedAt         DateTime?          @map("suspended_at") @db.Timestamptz(6)
  suspendReason       String?            @map("suspend_reason")
  // Timestamps
  createdAt           DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant            Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([type])
  @@index([status])
  @@index([trialEndsAt])
  @@map("merchant_subscriptions")
}

model MerchantBalance {
  id                  BigInt               @id @default(autoincrement())
  merchantId          BigInt               @unique @map("merchant_id")
  balance             Decimal              @default(0) @db.Decimal(12, 2)
  lastTopupAt         DateTime?            @map("last_topup_at") @db.Timestamptz(6)
  createdAt           DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant            Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  transactions        BalanceTransaction[]

  @@index([merchantId])
  @@map("merchant_balances")
}

model BalanceTransaction {
  id                  BigInt                  @id @default(autoincrement())
  balanceId           BigInt                  @map("balance_id")
  type                BalanceTransactionType
  amount              Decimal                 @db.Decimal(12, 2)
  balanceBefore       Decimal                 @map("balance_before") @db.Decimal(12, 2)
  balanceAfter        Decimal                 @map("balance_after") @db.Decimal(12, 2)
  description         String?
  orderId             BigInt?                 @map("order_id")
  paymentRequestId    BigInt?                 @map("payment_request_id")
  createdByUserId     BigInt?                 @map("created_by_user_id")
  createdAt           DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)

  balance             MerchantBalance         @relation(fields: [balanceId], references: [id], onDelete: Cascade)

  @@index([balanceId])
  @@index([type])
  @@index([createdAt])
  @@map("balance_transactions")
}

model PaymentRequest {
  id                  BigInt               @id @default(autoincrement())
  merchantId          BigInt               @map("merchant_id")
  type                PaymentRequestType
  status              PaymentRequestStatus @default(PENDING)
  currency            String               @default("IDR")
  amount              Decimal              @db.Decimal(12, 2)
  // For monthly: how many months
  monthsRequested     Int?                 @map("months_requested")
  // Bank transfer info (copied from SubscriptionPlan at creation)
  bankName            String?              @map("bank_name")
  bankAccountNumber   String?              @map("bank_account_number")
  bankAccountName     String?              @map("bank_account_name")
  // Merchant confirmation
  confirmedAt         DateTime?            @map("confirmed_at") @db.Timestamptz(6)
  transferProofUrl    String?              @map("transfer_proof_url")
  transferNotes       String?              @map("transfer_notes")
  // Admin verification
  verifiedAt          DateTime?            @map("verified_at") @db.Timestamptz(6)
  verifiedByUserId    BigInt?              @map("verified_by_user_id")
  verificationNotes   String?              @map("verification_notes")
  rejectedAt          DateTime?            @map("rejected_at") @db.Timestamptz(6)
  rejectionReason     String?              @map("rejection_reason")
  // Timestamps
  expiresAt           DateTime?            @map("expires_at") @db.Timestamptz(6)
  createdAt           DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant            Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([status])
  @@index([createdAt])
  @@map("payment_requests")
}

enum UserRole {
  SUPER_ADMIN
  MERCHANT_OWNER
  MERCHANT_STAFF
  DELIVERY
}

enum MerchantRole {
  OWNER
  STAFF
  DRIVER
}

enum SessionStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum DeliveryZoneType {
  RADIUS
  POLYGON
}

enum DeliveryStatus {
  PENDING_ASSIGNMENT
  ASSIGNED
  PICKED_UP
  DELIVERED
  FAILED
}

enum OrderStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  READY
  COMPLETED
  CANCELLED
}

enum ReservationStatus {
  PENDING
  ACCEPTED
  CANCELLED
}

enum AddonInputType {
  SELECT
  QTY
}

enum PaymentMethod {
  CASH_ON_COUNTER
  CARD_ON_COUNTER
  CASH_ON_DELIVERY
  ONLINE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ============================================
// SUBSCRIPTION SYSTEM ENUMS
// ============================================

enum SubscriptionType {
  TRIAL           // Free trial period
  DEPOSIT         // Deposit mode - deduct per order
  MONTHLY         // Monthly subscription
}

enum SubscriptionStatus {
  ACTIVE          // Subscription is valid
  SUSPENDED       // Auto-suspended (expired/no balance)
  CANCELLED       // Manually cancelled
}

enum BalanceTransactionType {
  DEPOSIT         // Top up balance
  ORDER_FEE       // Deduction per order (for deposit mode)
  SUBSCRIPTION    // Monthly subscription payment
  REFUND          // Admin refund
  ADJUSTMENT      // Manual admin adjustment
}

enum PaymentRequestStatus {
  PENDING         // Waiting for payment
  CONFIRMED       // Merchant clicked "I have paid"
  VERIFIED        // Admin verified payment
  REJECTED        // Admin rejected (invalid proof)
  EXPIRED         // Request expired (no action)
}

enum PaymentRequestType {
  DEPOSIT_TOPUP           // Top up deposit balance
  MONTHLY_SUBSCRIPTION    // Monthly subscription payment
}

enum NotificationType {
  TRIAL_ENDING_7_DAYS     // Trial ending in 7 days
  TRIAL_ENDING_3_DAYS     // Trial ending in 3 days
  TRIAL_ENDING_1_DAY      // Trial ending tomorrow
  TRIAL_EXPIRED           // Trial has expired
  LOW_BALANCE             // Balance below threshold
  BALANCE_ZERO            // Balance is zero
  NEGATIVE_BALANCE        // Balance is negative (auto-suspended)
  SUBSCRIPTION_SUSPENDED  // Subscription suspended
  PAYMENT_VERIFIED        // Payment verified
  PAYMENT_REJECTED        // Payment request rejected
  MONTHLY_EXPIRING_7_DAYS // Monthly subscription expiring in 7 days
  MONTHLY_EXPIRING_3_DAYS // Monthly subscription expiring in 3 days
  MONTHLY_EXPIRING_1_DAY  // Monthly subscription expiring tomorrow
  MONTHLY_EXPIRING        // Monthly subscription expiring (generic)
  MONTHLY_EXPIRED         // Monthly subscription expired
  AUTO_SWITCH_TO_DEPOSIT  // Auto-switched to deposit mode
  AUTO_SWITCH_TO_MONTHLY  // Auto-switched to monthly mode
  SUBSCRIPTION_REACTIVATED // Subscription reactivated
  STORE_CLOSED_BALANCE    // Store closed due to negative balance
  STORE_CLOSED_SUBSCRIPTION // Store closed due to expired subscription
}

model NotificationLog {
  id                  BigInt           @id @default(autoincrement())
  merchantId          BigInt           @map("merchant_id")
  type                NotificationType
  sentAt              DateTime         @default(now()) @map("sent_at") @db.Timestamptz(6)
  sentToEmail         String?          @map("sent_to_email")
  success             Boolean          @default(true)
  errorMessage        String?          @map("error_message")
  metadata            Json?            // Additional context data
  createdAt           DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  merchant            Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([type])
  @@index([sentAt])
  @@map("notification_logs")
}

// ============================================
// SUBSCRIPTION HISTORY / AUDIT LOG
// ============================================

enum SubscriptionEventType {
  CREATED              // Initial subscription created
  TRIAL_STARTED        // Trial period started
  TRIAL_EXPIRED        // Trial period ended
  UPGRADED_TO_DEPOSIT  // Switched to deposit mode
  UPGRADED_TO_MONTHLY  // Switched to monthly mode
  AUTO_SWITCHED        // Auto-switched between modes
  MANUAL_SWITCHED      // Manually switched between modes
  SUSPENDED            // Subscription suspended
  REACTIVATED          // Subscription reactivated
  PAYMENT_SUBMITTED    // Merchant submitted payment for verification
  PAYMENT_RECEIVED     // Payment verified and applied
  PAYMENT_REJECTED     // Payment request rejected
  PERIOD_EXTENDED      // Monthly period extended
  BALANCE_TOPUP        // Balance topped up
  ORDER_FEE_DEDUCTED   // Order fee deducted from balance
  GRACE_PERIOD_STARTED // Grace period started
  CANCELLED            // Subscription cancelled
}

model SubscriptionHistory {
  id                  BigInt                @id @default(autoincrement())
  merchantId          BigInt                @map("merchant_id")
  eventType           SubscriptionEventType @map("event_type")
  // Before state
  previousType        String?               @map("previous_type")
  previousStatus      String?               @map("previous_status")
  previousBalance     Decimal?              @map("previous_balance") @db.Decimal(12, 2)
  previousPeriodEnd   DateTime?             @map("previous_period_end") @db.Timestamptz(6)
  // After state
  newType             String?               @map("new_type")
  newStatus           String?               @map("new_status")
  newBalance          Decimal?              @map("new_balance") @db.Decimal(12, 2)
  newPeriodEnd        DateTime?             @map("new_period_end") @db.Timestamptz(6)
  // Additional info
  reason              String?               // Human-readable reason
  metadata            Json?                 // Additional context (paymentRequestId, etc)
  triggeredBy         String?               @map("triggered_by") // 'SYSTEM', 'ADMIN', 'MERCHANT'
  triggeredByUserId   BigInt?               @map("triggered_by_user_id")
  // Timestamps
  createdAt           DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([merchantId])
  @@index([eventType])
  @@index([createdAt])
  @@map("subscription_history")
}

// ============================================
// REFERRAL CODE SYSTEM
// ============================================

enum ReferralDiscountType {
  NONE              // No discount, just tracking
  PERCENTAGE        // % off deposit/subscription
  FIXED_AMOUNT      // Fixed amount off
  BONUS_DAYS        // Extra trial/subscription days
}

enum ReferralUsageType {
  REGISTRATION      // Used during merchant registration
  DEPOSIT_TOPUP     // Used during deposit top-up
  MONTHLY_SUBSCRIBE // Used for monthly subscription
}

model ReferralCode {
  id                  BigInt              @id @default(autoincrement())
  code                String              @unique
  description         String?
  discountType        ReferralDiscountType @default(NONE) @map("discount_type")
  discountValue       Decimal?            @map("discount_value") @db.Decimal(12, 2)
  maxUsage            Int?                @map("max_usage") // null = unlimited
  currentUsage        Int                 @default(0) @map("current_usage")
  isActive            Boolean             @default(true) @map("is_active")
  validFrom           DateTime?           @map("valid_from") @db.Timestamptz(6)
  validUntil          DateTime?           @map("valid_until") @db.Timestamptz(6)
  createdByUserId     BigInt              @map("created_by_user_id")
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  usages              ReferralUsage[]

  @@index([code])
  @@index([isActive])
  @@map("referral_codes")
}

model ReferralUsage {
  id                  BigInt              @id @default(autoincrement())
  referralCodeId      BigInt              @map("referral_code_id")
  merchantId          BigInt              @map("merchant_id")
  usageType           ReferralUsageType   @map("usage_type")
  paymentRequestId    BigInt?             @map("payment_request_id")
  discountApplied     Decimal?            @map("discount_applied") @db.Decimal(12, 2)
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)

  referralCode        ReferralCode        @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)

  @@index([referralCodeId])
  @@index([merchantId])
  @@map("referral_usages")
}

// ============================================
// IN-APP NOTIFICATION SYSTEM
// ============================================

enum UserNotificationCategory {
  SYSTEM           // System-wide announcements
  SUBSCRIPTION     // Trial ending, balance low, expired
  ORDER            // New orders, status changes
  STOCK            // Low stock, out of stock
  STAFF            // Staff logins, new staff added
  PAYMENT          // Payment verified, rejected
}

model UserNotification {
  id          BigInt                    @id @default(autoincrement())
  userId      BigInt?                   @map("user_id")
  merchantId  BigInt?                   @map("merchant_id")
  targetRole  UserRole?                 @map("target_role") // null = all roles in merchant
  category    UserNotificationCategory
  title       String
  message     String
  metadata    Json?                     // Extra data (orderId, menuId, etc.)
  isRead      Boolean                   @default(false) @map("is_read")
  readAt      DateTime?                 @map("read_at") @db.Timestamptz(6)
  actionUrl   String?                   @map("action_url") // Link to relevant page
  createdAt   DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)

  user        User?                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  merchant    Merchant?                 @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([merchantId, targetRole])
  @@index([createdAt])
  @@map("user_notifications")
}

// Notification Retry Queue for failed notifications with exponential backoff
enum NotificationRetryStatus {
  PENDING
  RETRYING
  SUCCESS
  FAILED
}

model NotificationRetryQueue {
  id            BigInt                    @id @default(autoincrement())
  notificationId BigInt?                  @map("notification_id")
  merchantId    BigInt?                   @map("merchant_id")
  userId        BigInt?                   @map("user_id")
  category      UserNotificationCategory
  title         String
  message       String
  metadata      Json?
  actionUrl     String?                   @map("action_url")
  targetRole    UserRole?                 @map("target_role")
  retryCount    Int                       @default(0) @map("retry_count")
  maxRetries    Int                       @default(5) @map("max_retries")
  nextRetryAt   DateTime?                 @map("next_retry_at") @db.Timestamptz(6)
  lastError     String?                   @map("last_error") @db.Text
  status        NotificationRetryStatus   @default(PENDING)
  createdAt     DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status, nextRetryAt])
  @@index([merchantId])
  @@index([userId])
  @@map("notification_retry_queue")
}

// ============================================
// PUSH NOTIFICATIONS (Web Push)
// ============================================

model PushSubscription {
  id          BigInt    @id @default(autoincrement())
  userId      BigInt    @map("user_id")
  merchantId  BigInt?   @map("merchant_id")
  endpoint    String    @db.Text
  p256dhKey   String    @map("p256dh_key") @db.Text
  authKey     String    @map("auth_key") @db.Text
  userAgent   String?   @map("user_agent")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  merchant    Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  @@unique([userId, endpoint])
  @@index([userId, isActive])
  @@index([merchantId])
  @@map("push_subscriptions")
}

// Customer Push Subscription - for customer-facing order status notifications
// Supports both logged-in customers and guest users (via orderNumbers)
model CustomerPushSubscription {
  id            BigInt    @id @default(autoincrement())
  customerId    BigInt?   @map("customer_id") // For logged-in customers
  endpoint      String    @db.Text
  p256dhKey     String    @map("p256dh_key") @db.Text
  authKey       String    @map("auth_key") @db.Text
  orderNumbers  String[]  @map("order_numbers") // For guest users - track specific orders
  userAgent     String?   @map("user_agent")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId, isActive])
  @@index([endpoint])
  @@map("customer_push_subscriptions")
}

// ============================================
// GROUP ORDER / SPLIT BILL SYSTEM
// ============================================

enum GroupOrderStatus {
  OPEN        // Accepting participants & items
  LOCKED      // Host clicked submit, processing
  SUBMITTED   // Order created from session
  CANCELLED   // Cancelled by host
  EXPIRED     // Auto-expired after 2 hours
}

model GroupOrderSession {
  id              BigInt            @id @default(autoincrement())
  sessionCode     String            @unique @map("session_code") // 4-char alphanumeric
  merchantId      BigInt            @map("merchant_id")
  orderType       OrderType         @map("order_type") // DINE_IN or TAKEAWAY
  tableNumber     String?           @map("table_number") // Optional (required for dine-in)
  status          GroupOrderStatus  @default(OPEN)
  orderId         BigInt?           @unique @map("order_id") // Final order after submission
  maxParticipants Int               @default(15) @map("max_participants")
  expiresAt       DateTime          @map("expires_at") @db.Timestamptz(6)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  merchant          Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  order             Order?            @relation(fields: [orderId], references: [id])
  participants      GroupOrderParticipant[]
  groupOrderDetails GroupOrderDetail[] // All item details for this session
  
  @@index([sessionCode])
  @@index([merchantId])
  @@index([status])
  @@index([expiresAt])
  @@map("group_order_sessions")
}

model GroupOrderParticipant {
  id              BigInt            @id @default(autoincrement())
  sessionId       BigInt            @map("session_id")
  customerId      BigInt?           @map("customer_id") // Optional (for logged-in users)
  name            String
  deviceId        String            @map("device_id") // For reconnection after refresh
  isHost          Boolean           @default(false) @map("is_host")
  cartItems       Json              @default("[]") @map("cart_items") // Same structure as CartContext
  subtotal        Decimal           @default(0) @db.Decimal(10, 2)
  joinedAt        DateTime          @default(now()) @map("joined_at") @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  session         GroupOrderSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  customer        Customer?         @relation(fields: [customerId], references: [id])
  groupOrderDetails GroupOrderDetail[] // Details of items in final order
  
  @@index([sessionId])
  @@index([deviceId])
  @@index([customerId])
  @@map("group_order_participants")
}

// Tracks which participant ordered which items (for bill splitting & history)
// This is a separate table to avoid modifying OrderItem structure
model GroupOrderDetail {
  id              BigInt                @id @default(autoincrement())
  sessionId       BigInt                @map("session_id")      // Group order session
  participantId   BigInt                @map("participant_id")  // Which participant ordered
  orderItemId     BigInt                @map("order_item_id")   // Which order item
  participantName String                @map("participant_name") // Denormalized for display
  itemSubtotal    Decimal               @map("item_subtotal") @db.Decimal(10, 2) // Participant's subtotal for this item
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  
  session         GroupOrderSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  participant     GroupOrderParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  orderItem       OrderItem             @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([participantId])
  @@index([orderItemId])
  @@map("group_order_details")
}

// Rate limiting for join attempts (prevent brute force)
model GroupJoinAttempt {
  id          BigInt    @id @default(autoincrement())
  deviceId    String    @map("device_id")
  attemptCode String    @map("attempt_code")
  success     Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  
  @@index([deviceId, createdAt])
  @@map("group_join_attempts")
}

// ============================================
// STOCK PHOTO LIBRARY
// ============================================

// Stock photos provided by Super Admin for merchants to use
model StockPhoto {
  id              BigInt    @id @default(autoincrement())
  category        String    // Category name for searching (e.g., "Burger", "Pizza", "Drinks")
  name            String    // Display name of the photo
  imageUrl        String    @map("image_url") // URL to the stock photo
  thumbnailUrl    String?   @map("thumbnail_url") // Optional smaller thumbnail
  thumbnailMeta   Json?     @map("thumbnail_meta") // Thumbnail variants + source dimensions
  uploadedByUserId BigInt   @map("uploaded_by_user_id") // Super Admin who uploaded
  isActive        Boolean   @default(true) @map("is_active")
  usageCount      Int       @default(0) @map("usage_count") // Track how many times used
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  uploadedBy      User      @relation("StockPhotoUploadedBy", fields: [uploadedByUserId], references: [id])
  
  @@index([category])
  @@index([name])
  @@index([isActive])
  @@index([uploadedByUserId])
  @@map("stock_photos")
}

// ============================================
// MAINTENANCE JOBS (Super Admin utilities)
// ============================================

enum MaintenanceJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model MaintenanceJob {
  id              BigInt              @id @default(autoincrement())
  jobKey           String              @unique @map("job_key")
  status           MaintenanceJobStatus @default(PENDING)
  progressCurrent  Int                 @default(0) @map("progress_current")
  progressTotal    Int                 @default(0) @map("progress_total")
  message          String?
  lastError        String?             @map("last_error")
  startedAt        DateTime?           @map("started_at") @db.Timestamptz(6)
  completedAt      DateTime?           @map("completed_at") @db.Timestamptz(6)
  createdAt        DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status])
  @@map("maintenance_jobs")
}

// ============================================
// VOUCHER SYSTEM
// ============================================

enum VoucherType {
  BALANCE           // Add balance to merchant account
  SUBSCRIPTION_DAYS // Add subscription days (monthly)
}

model Voucher {
  id                BigInt              @id @default(autoincrement())
  code              String              @unique
  type              VoucherType
  description       String?
  // Value: for BALANCE = amount, for SUBSCRIPTION_DAYS = number of days
  value             Decimal             @db.Decimal(12, 2)
  // Currency restriction: IDR, AUD, or null for universal
  currency          String?             // null means applicable to all currencies
  // Usage limits
  maxUsage          Int?                @map("max_usage") // null = unlimited
  currentUsage      Int                 @default(0) @map("current_usage")
  // Validity period
  validFrom         DateTime?           @map("valid_from") @db.Timestamptz(6)
  validUntil        DateTime?           @map("valid_until") @db.Timestamptz(6)
  // Status
  isActive          Boolean             @default(true) @map("is_active")
  // Audit
  createdByUserId   BigInt              @map("created_by_user_id")
  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  redemptions       VoucherRedemption[]

  @@index([code])
  @@index([type])
  @@index([currency])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("vouchers")
}

model VoucherRedemption {
  id              BigInt    @id @default(autoincrement())
  voucherId       BigInt    @map("voucher_id")
  merchantId      BigInt    @map("merchant_id")
  redeemedByUserId BigInt   @map("redeemed_by_user_id")
  // Snapshot of what was applied
  voucherCode     String    @map("voucher_code")
  voucherType     VoucherType @map("voucher_type")
  valueApplied    Decimal   @map("value_applied") @db.Decimal(12, 2)
  currency        String    // Merchant's currency at time of redemption
  // For BALANCE type: balance before/after
  balanceBefore   Decimal?  @map("balance_before") @db.Decimal(12, 2)
  balanceAfter    Decimal?  @map("balance_after") @db.Decimal(12, 2)
  // For SUBSCRIPTION_DAYS type: subscription period before/after
  subscriptionEndBefore DateTime? @map("subscription_end_before") @db.Timestamptz(6)
  subscriptionEndAfter  DateTime? @map("subscription_end_after") @db.Timestamptz(6)
  // Auto-switch tracking
  triggeredAutoSwitch Boolean @default(false) @map("triggered_auto_switch")
  previousSubType     String? @map("previous_sub_type") // TRIAL, DEPOSIT, MONTHLY
  newSubType          String? @map("new_sub_type")
  // Timestamps
  redeemedAt      DateTime  @default(now()) @map("redeemed_at") @db.Timestamptz(6)

  voucher         Voucher   @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@index([voucherId])
  @@index([merchantId])
  @@index([redeemedByUserId])
  @@index([redeemedAt])
  @@map("voucher_redemptions")
}