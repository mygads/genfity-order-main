generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  BigInt          @id @default(autoincrement())
  name                String
  email               String          @unique
  phone               String?
  passwordHash        String          @map("password_hash")
  profilePictureUrl   String?         @map("profile_picture_url")
  role                UserRole        @default(MERCHANT_STAFF)
  isActive            Boolean         @default(true) @map("is_active")
  mustChangePassword  Boolean         @default(false) @map("must_change_password")
  resetToken          String?         @map("reset_token")
  resetTokenExpiresAt DateTime?       @map("reset_token_expires_at") @db.Timestamptz(6)
  lastLoginAt         DateTime?       @map("last_login_at") @db.Timestamptz(6)
  createdAt           DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCatsCreated    AddonCategory[] @relation("AddonCatCreatedBy")
  addonCatsDeleted    AddonCategory[] @relation("AddonCatDeletedBy")
  addonCatsUpdated    AddonCategory[] @relation("AddonCatUpdatedBy")
  addonItemsCreated   AddonItem[]     @relation("AddonItemCreatedBy")
  addonItemsDeleted   AddonItem[]     @relation("AddonItemDeletedBy")
  addonItemsUpdated   AddonItem[]     @relation("AddonItemUpdatedBy")
  categoriesCreated   MenuCategory[]  @relation("CategoryCreatedBy")
  categoriesDeleted   MenuCategory[]  @relation("CategoryDeletedBy")
  categoriesUpdated   MenuCategory[]  @relation("CategoryUpdatedBy")
  menusCreated        Menu[]          @relation("MenuCreatedBy")
  menusDeleted        Menu[]          @relation("MenuDeletedBy")
  menusUpdated        Menu[]          @relation("MenuUpdatedBy")
  merchantUsers       MerchantUser[]
  paymentsRecorded    Payment[]       @relation("PaymentRecordedBy")
  preferences         UserPreference?
  sessions            UserSession[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model UserSession {
  id               BigInt        @id @default(autoincrement())
  userId           BigInt        @map("user_id")
  token            String        @unique
  deviceInfo       String?       @map("device_info")
  ipAddress        String?       @map("ip_address")
  status           SessionStatus @default(ACTIVE)
  expiresAt        DateTime      @map("expires_at") @db.Timestamptz(6)
  refreshExpiresAt DateTime?     @map("refresh_expires_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([status])
  @@map("user_sessions")
}

model UserPreference {
  id                 BigInt   @id @default(autoincrement())
  userId             BigInt   @unique @map("user_id")
  theme              String   @default("light")
  language           String   @default("en")
  timezone           String   @default("Asia/Jakarta")
  dateFormat         String   @default("DD/MM/YYYY") @map("date_format")
  timeFormat         String   @default("24h") @map("time_format")
  currency           String   @default("AUD")
  emailNotifications Boolean  @default(true) @map("email_notifications")
  orderNotifications Boolean  @default(true) @map("order_notifications")
  marketingEmails    Boolean  @default(false) @map("marketing_emails")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_preferences")
}

// ============================================
// CUSTOMER (Separate from Admin/Merchant Users)
// ============================================

model Customer {
  id                  BigInt            @id @default(autoincrement())
  name                String
  email               String            @unique
  phone               String?
  passwordHash        String?           @map("password_hash")
  isActive            Boolean           @default(true) @map("is_active")
  mustChangePassword  Boolean           @default(false) @map("must_change_password")
  resetToken          String?           @map("reset_token")
  resetTokenExpiresAt DateTime?         @map("reset_token_expires_at") @db.Timestamptz(6)
  lastLoginAt         DateTime?         @map("last_login_at") @db.Timestamptz(6)
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  // Customer segmentation fields
  totalOrders         Int               @default(0) @map("total_orders")
  totalSpent          Decimal           @default(0) @map("total_spent") @db.Decimal(10, 2)
  lastOrderAt         DateTime?         @map("last_order_at") @db.Timestamptz(6)
  
  orders              Order[]
  sessions            CustomerSession[]
  favorites           CustomerFavorite[]

  @@index([email])
  @@index([phone])
  @@index([totalOrders])
  @@index([lastOrderAt])
  @@map("customers")
}

// Customer Favorite Menus
model CustomerFavorite {
  id          BigInt   @id @default(autoincrement())
  customerId  BigInt   @map("customer_id")
  merchantId  BigInt   @map("merchant_id")
  menuId      BigInt   @map("menu_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, menuId])
  @@index([customerId])
  @@index([merchantId])
  @@index([menuId])
  @@map("customer_favorites")
}

model CustomerSession {
  id               BigInt        @id @default(autoincrement())
  customerId       BigInt        @map("customer_id")
  token            String        @unique
  deviceInfo       String?       @map("device_info")
  ipAddress        String?       @map("ip_address")
  status           SessionStatus @default(ACTIVE)
  expiresAt        DateTime      @map("expires_at") @db.Timestamptz(6)
  refreshExpiresAt DateTime?     @map("refresh_expires_at") @db.Timestamptz(6)
  createdAt        DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  customer         Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([token])
  @@index([status])
  @@map("customer_sessions")
}

model MerchantUser {
  id         BigInt       @id @default(autoincrement())
  merchantId BigInt       @map("merchant_id")
  userId     BigInt       @map("user_id")
  role       MerchantRole @default(STAFF)
  // Staff Permissions - JSON array of permission keys
  // null means all permissions (for OWNER), empty array means no permissions
  // Example: ["orders", "menu", "categories", "stock"]
  permissions String[]    @default([])
  isActive    Boolean     @default(true) @map("is_active")
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([merchantId, userId])
  @@index([merchantId])
  @@index([userId])
  @@index([isActive])
  @@map("merchant_users")
}

model Merchant {
  id                     BigInt                @id @default(autoincrement())
  code                   String                @unique
  name                   String
  email                  String
  phone                  String?
  address                String?
  city                   String?
  state                  String?
  postalCode             String?               @map("postal_code")
  country                String                @default("Australia")
  logoUrl                String?               @map("logo_url")
  bannerUrl              String?               @map("banner_url")
  mapUrl                 String?               @map("map_url")
  description            String?
  isActive               Boolean               @default(true) @map("is_active")
  enableTax              Boolean               @default(false) @map("enable_tax")
  taxPercentage          Decimal?              @map("tax_percentage") @db.Decimal(5, 2)
  enableServiceCharge    Boolean               @default(false) @map("enable_service_charge")
  serviceChargePercent   Decimal?              @map("service_charge_percent") @db.Decimal(5, 2)
  enablePackagingFee     Boolean               @default(false) @map("enable_packaging_fee")
  packagingFeeAmount     Decimal?              @map("packaging_fee_amount") @db.Decimal(10, 2)
  currency               String                @default("AUD")
  createdAt              DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  isOpen                 Boolean               @default(true) @map("is_open")
  isManualOverride       Boolean               @default(false) @map("is_manual_override") // When true, isOpen overrides schedule
  isDineInEnabled        Boolean               @default(true) @map("is_dine_in_enabled")
  isTakeawayEnabled      Boolean               @default(true) @map("is_takeaway_enabled")
  dineInLabel            String?               @map("dine_in_label")
  takeawayLabel          String?               @map("takeaway_label")
  dineInScheduleStart    String?               @map("dine_in_schedule_start")
  dineInScheduleEnd      String?               @map("dine_in_schedule_end")
  takeawayScheduleStart  String?               @map("takeaway_schedule_start")
  takeawayScheduleEnd    String?               @map("takeaway_schedule_end")
  totalTables            Int?                  @map("total_tables")
  latitude               Decimal?              @db.Decimal(10, 8)
  longitude              Decimal?              @db.Decimal(11, 8)
  timezone               String                @default("Australia/Sydney")
  addonCategories        AddonCategory[]
  menuCategories         MenuCategory[]
  menus                  Menu[]
  openingHours           MerchantOpeningHour[]
  modeSchedules          MerchantModeSchedule[]
  specialHours           MerchantSpecialHour[]
  merchantUsers          MerchantUser[]
  orders                 Order[]
  menuBooks              MenuBook[]
  specialPrices          SpecialPrice[]

  @@index([code])
  @@index([isActive])
  @@map("merchants")
}

model MerchantOpeningHour {
  id         BigInt   @id @default(autoincrement())
  merchantId BigInt   @map("merchant_id")
  dayOfWeek  Int      @map("day_of_week")
  openTime   String?  @map("open_time")
  closeTime  String?  @map("close_time")
  isClosed   Boolean  @default(false) @map("is_closed")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, dayOfWeek])
  @@map("merchant_opening_hours")
}

// ============================================
// PER-DAY MODE SCHEDULES
// Different mode availability for each day of week
// ============================================

model MerchantModeSchedule {
  id         BigInt    @id @default(autoincrement())
  merchantId BigInt    @map("merchant_id")
  mode       OrderType @default(DINE_IN)
  dayOfWeek  Int       @map("day_of_week") // 0=Sunday, 6=Saturday
  startTime  String    @map("start_time") // HH:MM format
  endTime    String    @map("end_time") // HH:MM format
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant   Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, mode, dayOfWeek])
  @@index([merchantId])
  @@index([dayOfWeek])
  @@map("merchant_mode_schedules")
}

// ============================================
// HOLIDAY / SPECIAL HOURS
// Override regular hours for specific dates
// ============================================

model MerchantSpecialHour {
  id                 BigInt    @id @default(autoincrement())
  merchantId         BigInt    @map("merchant_id")
  date               DateTime  @map("date") @db.Date
  name               String?   // "Christmas Day", "New Year's Eve"
  isClosed           Boolean   @default(false) @map("is_closed")
  openTime           String?   @map("open_time")
  closeTime          String?   @map("close_time")
  // Mode overrides for this day
  isDineInEnabled    Boolean?  @map("is_dine_in_enabled")
  isTakeawayEnabled  Boolean?  @map("is_takeaway_enabled")
  dineInStartTime    String?   @map("dine_in_start_time")
  dineInEndTime      String?   @map("dine_in_end_time")
  takeawayStartTime  String?   @map("takeaway_start_time")
  takeawayEndTime    String?   @map("takeaway_end_time")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  merchant           Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, date])
  @@index([merchantId])
  @@index([date])
  @@map("merchant_special_hours")
}

model MenuCategory {
  id              BigInt             @id @default(autoincrement())
  merchantId      BigInt             @map("merchant_id")
  name            String
  description     String?
  sortOrder       Int                @default(0) @map("sort_order")
  isActive        Boolean            @default(true) @map("is_active")
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdByUserId BigInt?            @map("created_by_user_id")
  deletedAt       DateTime?          @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId BigInt?            @map("deleted_by_user_id")
  updatedByUserId BigInt?            @map("updated_by_user_id")
  createdBy       User?              @relation("CategoryCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy       User?              @relation("CategoryDeletedBy", fields: [deletedByUserId], references: [id])
  merchant        Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  updatedBy       User?              @relation("CategoryUpdatedBy", fields: [updatedByUserId], references: [id])
  menuItems       MenuCategoryItem[]
  menus           Menu[]

  @@index([merchantId])
  @@index([sortOrder])
  @@index([deletedAt])
  @@map("menu_categories")
}

model MenuCategoryItem {
  id         BigInt       @id @default(autoincrement())
  menuId     BigInt       @map("menu_id")
  categoryId BigInt       @map("category_id")
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  category   MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  menu       Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([menuId, categoryId])
  @@index([menuId])
  @@index([categoryId])
  @@map("menu_category_items")
}

model Menu {
  id                 BigInt              @id @default(autoincrement())
  merchantId         BigInt              @map("merchant_id")
  categoryId         BigInt?             @map("category_id")
  name               String
  description        String?
  price              Decimal             @db.Decimal(10, 2)
  imageUrl           String?             @map("image_url")
  isActive           Boolean             @default(true) @map("is_active")
  // Note: Promo fields removed - use SpecialPrice/SpecialPriceItem tables instead
  trackStock         Boolean             @default(false) @map("track_stock")
  stockQty           Int?                @map("stock_qty")
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  autoResetStock     Boolean             @default(false) @map("auto_reset_stock")
  dailyStockTemplate Int?                @map("daily_stock_template")
  lastStockResetAt   DateTime?           @map("last_stock_reset_at") @db.Timestamptz(6)
  createdByUserId    BigInt?             @map("created_by_user_id")
  deletedAt          DateTime?           @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId    BigInt?             @map("deleted_by_user_id")
  updatedByUserId    BigInt?             @map("updated_by_user_id")
  isSpicy            Boolean             @default(false) @map("is_spicy")
  isBestSeller       Boolean             @default(false) @map("is_best_seller")
  isSignature        Boolean             @default(false) @map("is_signature")
  isRecommended      Boolean             @default(false) @map("is_recommended")
  // Menu Scheduling - Auto-enable/disable based on time
  scheduleEnabled    Boolean             @default(false) @map("schedule_enabled")
  scheduleStartTime  String?             @map("schedule_start_time") // HH:MM format
  scheduleEndTime    String?             @map("schedule_end_time") // HH:MM format
  scheduleDays       Int[]               @default([]) @map("schedule_days") // 0=Sun, 1=Mon, ... 6=Sat
  // Cost for profit calculation
  costPrice          Decimal?            @map("cost_price") @db.Decimal(10, 2)
  addonCategories    MenuAddonCategory[]
  categories         MenuCategoryItem[]
  category           MenuCategory?       @relation(fields: [categoryId], references: [id])
  createdBy          User?               @relation("MenuCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy          User?               @relation("MenuDeletedBy", fields: [deletedByUserId], references: [id])
  merchant           Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  updatedBy          User?               @relation("MenuUpdatedBy", fields: [updatedByUserId], references: [id])
  orderItems         OrderItem[]
  menuBookItems      MenuBookItem[]
  specialPriceItems  SpecialPriceItem[]

  @@index([merchantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([scheduleEnabled])
  @@index([name]) // For search optimization
  @@map("menus")
}

model AddonCategory {
  id                  BigInt              @id @default(autoincrement())
  merchantId          BigInt              @map("merchant_id")
  name                String
  description         String?
  minSelection        Int                 @default(0) @map("min_selection")
  maxSelection        Int?                @map("max_selection")
  isActive            Boolean             @default(true) @map("is_active")
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdByUserId     BigInt?             @map("created_by_user_id")
  deletedAt           DateTime?           @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId     BigInt?             @map("deleted_by_user_id")
  updatedByUserId     BigInt?             @map("updated_by_user_id")
  createdBy           User?               @relation("AddonCatCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy           User?               @relation("AddonCatDeletedBy", fields: [deletedByUserId], references: [id])
  merchant            Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  updatedBy           User?               @relation("AddonCatUpdatedBy", fields: [updatedByUserId], references: [id])
  addonItems          AddonItem[]
  menuAddonCategories MenuAddonCategory[]

  @@index([merchantId])
  @@index([deletedAt])
  @@map("addon_categories")
}

model AddonItem {
  id                 BigInt           @id @default(autoincrement())
  addonCategoryId    BigInt           @map("addon_category_id")
  name               String
  description        String?
  price              Decimal          @default(0) @db.Decimal(10, 2)
  isActive           Boolean          @default(true) @map("is_active")
  trackStock         Boolean          @default(false) @map("track_stock")
  stockQty           Int?             @map("stock_qty")
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  inputType          AddonInputType   @default(SELECT) @map("input_type")
  displayOrder       Int              @default(0) @map("display_order")
  autoResetStock     Boolean          @default(false) @map("auto_reset_stock")
  createdByUserId    BigInt?          @map("created_by_user_id")
  dailyStockTemplate Int?             @map("daily_stock_template")
  deletedAt          DateTime?        @map("deleted_at") @db.Timestamptz(6)
  deletedByUserId    BigInt?          @map("deleted_by_user_id")
  lastStockResetAt   DateTime?        @map("last_stock_reset_at") @db.Timestamptz(6)
  updatedByUserId    BigInt?          @map("updated_by_user_id")
  addonCategory      AddonCategory    @relation(fields: [addonCategoryId], references: [id], onDelete: Cascade)
  createdBy          User?            @relation("AddonItemCreatedBy", fields: [createdByUserId], references: [id])
  deletedBy          User?            @relation("AddonItemDeletedBy", fields: [deletedByUserId], references: [id])
  updatedBy          User?            @relation("AddonItemUpdatedBy", fields: [updatedByUserId], references: [id])
  orderItemAddons    OrderItemAddon[]

  @@index([addonCategoryId])
  @@index([displayOrder])
  @@index([autoResetStock, lastStockResetAt])
  @@index([deletedAt])
  @@map("addon_items")
}

model MenuAddonCategory {
  menuId          BigInt        @map("menu_id")
  addonCategoryId BigInt        @map("addon_category_id")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  displayOrder    Int           @default(0) @map("display_order")
  isRequired      Boolean       @default(false) @map("is_required")
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonCategory   AddonCategory @relation(fields: [addonCategoryId], references: [id], onDelete: Cascade)
  menu            Menu          @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@id([menuId, addonCategoryId])
  @@index([menuId])
  @@index([addonCategoryId])
  @@index([displayOrder])
  @@map("menu_addon_categories")
}

model Order {
  id                   BigInt      @id @default(autoincrement())
  merchantId           BigInt      @map("merchant_id")
  customerId           BigInt?     @map("customer_id")
  orderNumber          String      @map("order_number")
  orderType            OrderType   @map("order_type")
  tableNumber          String?     @map("table_number")
  status               OrderStatus @default(PENDING)
  subtotal             Decimal     @db.Decimal(10, 2)
  taxAmount            Decimal     @default(0) @map("tax_amount") @db.Decimal(10, 2)
  serviceChargeAmount  Decimal     @default(0) @map("service_charge_amount") @db.Decimal(10, 2)
  packagingFeeAmount   Decimal     @default(0) @map("packaging_fee") @db.Decimal(10, 2)
  totalAmount          Decimal     @map("total_amount") @db.Decimal(10, 2)
  notes                String?
  placedAt             DateTime    @default(now()) @map("placed_at") @db.Timestamptz(6)
  createdAt            DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  actualReadyAt        DateTime?   @map("actual_ready_at") @db.Timestamptz(6)
  cancelReason         String?     @map("cancel_reason")
  cancelledAt          DateTime?   @map("cancelled_at") @db.Timestamptz(6)
  completedAt          DateTime?   @map("completed_at") @db.Timestamptz(6)
  estimatedReadyAt     DateTime?   @map("estimated_ready_at") @db.Timestamptz(6)
  orderItems           OrderItem[]
  customer             Customer?   @relation(fields: [customerId], references: [id])
  merchant             Merchant    @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  payment              Payment?

  @@unique([merchantId, orderNumber])
  @@index([merchantId])
  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@index([placedAt])
  @@index([estimatedReadyAt])
  @@map("orders")
}

model OrderItem {
  id        BigInt           @id @default(autoincrement())
  orderId   BigInt           @map("order_id")
  menuId    BigInt           @map("menu_id")
  menuName  String           @map("menu_name")
  menuPrice Decimal          @map("menu_price") @db.Decimal(10, 2)
  quantity  Int
  subtotal  Decimal          @db.Decimal(10, 2)
  notes     String?
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  addons    OrderItemAddon[]
  menu      Menu             @relation(fields: [menuId], references: [id])
  order     Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([menuId])
  @@map("order_items")
}

model OrderItemAddon {
  id          BigInt    @id @default(autoincrement())
  orderItemId BigInt    @map("order_item_id")
  addonItemId BigInt    @map("addon_item_id")
  addonName   String    @map("addon_name")
  addonPrice  Decimal   @map("addon_price") @db.Decimal(10, 2)
  quantity    Int
  subtotal    Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  addonItem   AddonItem @relation(fields: [addonItemId], references: [id])
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
  @@index([addonItemId])
  @@map("order_item_addons")
}

model Payment {
  id                   BigInt        @id @default(autoincrement())
  orderId              BigInt        @unique @map("order_id")
  amount               Decimal       @db.Decimal(10, 2)
  paymentMethod        PaymentMethod @map("payment_method")
  status               PaymentStatus @default(PENDING)
  paidByUserId         BigInt?       @map("paid_by_user_id")
  paidAt               DateTime?     @map("paid_at") @db.Timestamptz(6)
  gatewayProvider      String?       @map("gateway_provider")
  gatewayTransactionId String?       @map("gateway_transaction_id")
  gatewayStatus        String?       @map("gateway_status")
  gatewayResponse      Json?         @map("gateway_response")
  gatewayCallbackAt    DateTime?     @map("gateway_callback_at") @db.Timestamptz(6)
  notes                String?
  metadata             Json?
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  order                Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paidBy               User?         @relation("PaymentRecordedBy", fields: [paidByUserId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([paymentMethod])
  @@index([gatewayTransactionId])
  @@index([paidAt])
  @@map("payments")
}

// ============================================
// MENU BOOKS & SPECIAL PRICES
// ============================================

model MenuBook {
  id            BigInt         @id @default(autoincrement())
  merchantId    BigInt         @map("merchant_id")
  name          String
  description   String?
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant      Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  items         MenuBookItem[]
  specialPrices SpecialPrice[]

  @@index([merchantId])
  @@index([isActive])
  @@map("menu_books")
}

model MenuBookItem {
  id          BigInt   @id @default(autoincrement())
  menuBookId  BigInt   @map("menu_book_id")
  menuId      BigInt   @map("menu_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  menuBook    MenuBook @relation(fields: [menuBookId], references: [id], onDelete: Cascade)
  menu        Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([menuBookId, menuId])
  @@index([menuBookId])
  @@index([menuId])
  @@map("menu_book_items")
}

model SpecialPrice {
  id             BigInt             @id @default(autoincrement())
  merchantId     BigInt             @map("merchant_id")
  menuBookId     BigInt             @map("menu_book_id")
  name           String
  startDate      DateTime           @map("start_date") @db.Date
  endDate        DateTime           @map("end_date") @db.Date
  applicableDays Int[]              @map("applicable_days")
  isAllDay       Boolean            @default(true) @map("is_all_day")
  startTime      String?            @map("start_time")
  endTime        String?            @map("end_time")
  isActive       Boolean            @default(true) @map("is_active")
  createdAt      DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)

  merchant       Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  menuBook       MenuBook           @relation(fields: [menuBookId], references: [id], onDelete: Cascade)
  priceItems     SpecialPriceItem[]

  @@index([merchantId])
  @@index([menuBookId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("special_prices")
}

model SpecialPriceItem {
  id             BigInt       @id @default(autoincrement())
  specialPriceId BigInt       @map("special_price_id")
  menuId         BigInt       @map("menu_id")
  promoPrice     Decimal      @map("promo_price") @db.Decimal(10, 2)
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  specialPrice   SpecialPrice @relation(fields: [specialPriceId], references: [id], onDelete: Cascade)
  menu           Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([specialPriceId, menuId])
  @@index([specialPriceId])
  @@index([menuId])
  @@map("special_price_items")
}

enum UserRole {
  SUPER_ADMIN
  MERCHANT_OWNER
  MERCHANT_STAFF
}

enum MerchantRole {
  OWNER
  STAFF
}

enum SessionStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum OrderType {
  DINE_IN
  TAKEAWAY
}

enum OrderStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  READY
  COMPLETED
  CANCELLED
}

enum AddonInputType {
  SELECT
  QTY
}

enum PaymentMethod {
  CASH_ON_COUNTER
  CARD_ON_COUNTER
  BANK_TRANSFER
  E_WALLET
  QRIS
  CREDIT_CARD
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}
